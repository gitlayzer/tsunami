apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-tsunami-sa
  namespace: kube-system
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: kube-tsunami-role
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: kube-tsunami-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-tsunami-role
subjects:
- kind: ServiceAccount
  name: kube-tsunami-sa
  namespace: kube-system
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: kube-tsunami-config
  namespace: kube-system
  labels:
    tier: node
    app: kube-tsunami
data:
  cni-conf.json: |
    {
      "name": "mycninet",
      "cniVersion": "0.3.1",
      "type": "cni-tsunami",
      "server_socket": "/var/run/cniserver.sock",
      "delegate": {
          "cniVersion": "0.3.1",
          "name": "mycninet",
          "type": "bridge",
          "bridge": "mybr0",
          "isGateway": false,
          "ipam": {
            "type": "dhcp"
          }
      }
    }
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-tsunami-ds
  namespace: kube-system
  labels:
    tier: node
    app: kube-tsunami
spec:
  selector:
    matchLabels:
      app: kube-tsunami
  template:
    metadata:
      labels:
        tier: node
        app: kube-tsunami
    spec:
      serviceAccountName: kube-tsunami-sa
      hostNetwork: true
      hostPID: true
      tolerations:
      - operator: Exists
        effect: NoSchedule
      initContainers:
        - name: cp-cni-config
          image: layzer/tsunami:v0.0.1
          command:
          - cp
          args:
          - -f
          - /etc/kube-tsunami/cni-conf.json
          - /etc/cni/net.d/10-cni-tsunami.conf
          volumeMounts:
          - name: kube-tsunami-config
            mountPath: /etc/kube-tsunami/
          - name: cni-config-dir
            mountPath: /etc/cni/net.d
        - name: cp-cni-bin
          image: layzer/tsunami:v0.0.1
          command:
          - cp
          args:
          - -f
          - /tsunami
          - /opt/cni/bin/tsunami
          ## 挂载源目录和目标目录, 拷贝tsunami可执行文件.
          volumeMounts:
            - name: cni-bin
              mountPath: /opt/cni/bin
      containers:
        - name: kube-tsunami
          image: layzer/tsunami:v0.0.1
          command:
          - /tsunami
          ## args:
          ## - --bridge
          ## - mybr0
          ## - --iface
          ## - ens33
          resources:
            requests:
              cpu: "100m"
              memory: "50Mi"
            limits:
              cpu: "100m"
              memory: "50Mi"
          securityContext:
            privileged: false
            capabilities:
              add: ["NET_ADMIN", "SYS_PTRACE", "SYS_ADMIN"]
          volumeMounts:
            - name: dhcp-sock
              mountPath: /run/cni/
            - name: cni-bin
              mountPath: /opt/cni/bin
            - name: cni-config-dir
              mountPath: /etc/cni/net.d
      volumes:
        - name: dhcp-sock
          hostPath:
            path: /run/cni/
        - name: cni-config-dir
          hostPath:
            path: /etc/cni/net.d
        - name: cni-bin
          hostPath:
            path: /opt/cni/bin
        - name: kube-tsunami-config
          configMap:
            name: kube-tsunami-config
